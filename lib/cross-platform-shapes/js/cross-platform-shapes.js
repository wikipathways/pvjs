/* cross-platform-shapes 0.0.8
Built on 2014-04-19
https://github.com/ariutta/cross-platform-shapes
License: http://www.apache.org/licenses/LICENSE-2.0/ */

var crossPlatformShapesNS = crossPlatformShapesNS || {};
crossPlatformShapesNS["markers.svg"] = '<svg id="markers" version="1.1" baseProfile="full" xmlns="http://www.w3.org/1999/xlink" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events" preserveAspectRatio="xMidYMid">\n<g>\n<desc>This SVG file contains a set of markers that can be duplicated for other colors.</desc>\n</g>\n<title>markers</title>\n<defs>\n<marker id="shape-library-markers-arrow-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-arrow-svg-start-default" class="solid-stroke default-fill-color">\n\n	<!-- arrow markers: triangular polygons, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,11 0,6 12,1"></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-arrow-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-arrow-svg-end-default" class="solid-stroke default-fill-color" transform="rotate(180, 6, 6)">\n\n	<!-- arrow markers: triangular polygons, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,11 0,6 12,1"></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-necessary-stimulation-svg-start-default" preserveAspectRatio="none" viewBox="0 0 16 12" markerWidth="16" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6">\n<g id="g-src-shape-library-markers-mim-necessary-stimulation-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-necessary-stimulation markers: triangular polygons, drawing-board fill, default color stroke; and vertical line -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<line fill="none" stroke-width="1" x1="14" y1="0" x2="14" y2="12"></line>\n	<line fill="none" stroke="none" x1="16" y1="6" x2="16" y2="6"></line> <!-- dummy point -->\n	<polygon stroke-width="1" points="0,6 9,11 9,1"></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-necessary-stimulation-svg-end-default" preserveAspectRatio="none" viewBox="0 0 16 12" markerWidth="16" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="16" refY="6"><g id="g-src-shape-library-markers-mim-necessary-stimulation-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 8, 6)">\n\n	<!-- mim-necessary-stimulation markers: triangular polygons, drawing-board fill, default color stroke; and vertical line -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<line fill="none" stroke-width="1" x1="14" y1="0" x2="14" y2="12"></line>\n	<line fill="none" stroke="none" x1="16" y1="6" x2="16" y2="6"></line> <!-- dummy point -->\n	<polygon stroke-width="1" points="0,6 9,11 9,1"></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-binding-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-mim-binding-svg-start-default" class="solid-stroke default-fill-color">\n\n	<!-- mim-binding markers: four-point polygon, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,12 0,6 12,0 5,6 "></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-binding-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-mim-binding-svg-end-default" class="solid-stroke default-fill-color" transform="rotate(180, 6, 6)">\n\n	<!-- mim-binding markers: four-point polygon, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,12 0,6 12,0 5,6 "></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-conversion-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-mim-conversion-svg-start-default" class="solid-stroke default-fill-color">\n\n	<!-- mim-conversion markers: triangular polygons, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,11 0,6 12,1"></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-conversion-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-mim-conversion-svg-end-default" class="solid-stroke default-fill-color" transform="rotate(180, 6, 6)">\n\n	<!-- mim-conversion markers: triangular polygons, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,11 0,6 12,1"></polygon>\n\n</g></marker>\n<marker id="shape-library-markers-mim-stimulation-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-mim-stimulation-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-stimulation markers: triangular polygons, drawing-board fill, default color stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<line stroke="none" fill="none" x1="12" y1="6" x2="12" y2="6"></line> <!-- dummy point -->\n	<polygon stroke-width="1" points="0,6 11,11 11,1"></polygon>\n\n</g></marker><marker id="shape-library-markers-mim-stimulation-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-mim-stimulation-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 6, 6)">\n\n	<!-- mim-stimulation markers: triangular polygons, drawing-board fill, default color stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<line stroke="none" fill="none" x1="12" y1="6" x2="12" y2="6"></line> <!-- dummy point -->\n	<polygon stroke-width="1" points="0,6 11,11 11,1"></polygon>\n\n</g></marker><marker id="shape-library-markers-mim-modification-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-mim-modification-svg-start-default" class="default-fill-color solid-stroke">\n\n	<!-- mim-modification markers: four-point polygon, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,12 0,6 12,0 5,6 "></polygon>\n\n</g></marker><marker id="shape-library-markers-mim-modification-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-mim-modification-svg-end-default" class="default-fill-color solid-stroke" transform="rotate(180, 6, 6)">\n\n	<!-- mim-modification markers: four-point polygon, no stroke -->\n\n	<rect class="board-fill-color" stroke="none" x="0" y="5.4" width="2" height="1.2"></rect>\n	<polygon stroke-width="0" points="12,12 0,6 12,0 5,6 "></polygon>\n\n</g></marker><marker id="shape-library-markers-mim-catalysis-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-mim-catalysis-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-catalysis markers: circle, drawing-board fill and default color stroke -->\n\n	<circle cx="6.0" cy="6" r="5.3px" stroke-width="1px"></circle>\n\n</g></marker><marker id="shape-library-markers-mim-catalysis-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-mim-catalysis-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 6, 6)">\n\n	<!-- mim-catalysis markers: circle, drawing-board fill and default color stroke -->\n\n	<circle cx="6.0" cy="6" r="5.3px" stroke-width="1px"></circle>\n\n</g></marker><marker id="shape-library-markers-mim-inhibition-svg-start-default" preserveAspectRatio="none" viewBox="0 0 10 20" markerWidth="10" markerHeight="20" markerUnits="strokeWidth" orient="auto" refX="0" refY="10"><g id="g-src-shape-library-markers-mim-inhibition-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-inhibition markers: vertical line; and extended drawing-board rect -->\n	\n	<rect stroke="none" x="0" y="9" width="8" height="2"></rect>\n	<line fill="none" stroke-width="1.8" x1="7" y1="0" x2="7" y2="20"></line>\n\n</g></marker><marker id="shape-library-markers-mim-inhibition-svg-end-default" preserveAspectRatio="none" viewBox="0 0 10 20" markerWidth="10" markerHeight="20" markerUnits="strokeWidth" orient="auto" refX="10" refY="10"><g id="g-src-shape-library-markers-mim-inhibition-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 5, 10)">\n\n	<!-- mim-inhibition markers: vertical line; and extended drawing-board rect -->\n	\n	<rect stroke="none" x="0" y="9" width="8" height="2"></rect>\n	<line fill="none" stroke-width="1.8" x1="7" y1="0" x2="7" y2="20"></line>\n\n</g></marker><marker id="shape-library-markers-mim-cleavage-svg-start-default" preserveAspectRatio="none" viewBox="0 0 20 30" markerWidth="20" markerHeight="30" markerUnits="strokeWidth" orient="auto" refX="9" refY="15"><g id="g-src-shape-library-markers-mim-cleavage-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-cleavage markers: two lines and extended drawing-board rect -->\n\n	<rect stroke="none" x="0" y="14.3" width="18.4" height="1.4"></rect>\n	<line fill="none" stroke-width="1" x1="18" y1="14.5" x2="18" y2="30"></line>	\n	<line fill="none" stroke-width="1" x1="18" y1="30" x2="0" y2="0"></line>	\n\n\n</g></marker><marker id="shape-library-markers-mim-cleavage-svg-end-default" preserveAspectRatio="none" viewBox="0 0 20 30" markerWidth="20" markerHeight="30" markerUnits="strokeWidth" orient="auto" refX="10" refY="15"><g id="g-src-shape-library-markers-mim-cleavage-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 10, 15)">\n\n	<!-- mim-cleavage markers: two lines and extended drawing-board rect -->\n\n	<rect stroke="none" x="0" y="14.3" width="18.4" height="1.4"></rect>\n	<line fill="none" stroke-width="1" x1="18" y1="14.5" x2="18" y2="30"></line>	\n	<line fill="none" stroke-width="1" x1="18" y1="30" x2="0" y2="0"></line>	\n\n\n</g></marker><marker id="shape-library-markers-mim-covalent-bond-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="-0.5" refY="6"><g id="g-src-shape-library-markers-mim-covalent-bond-svg-start-default" class="solid-stroke default-fill-color">\n\n	<!-- mim-covalent-bond markers: not much to see here! -->\n	<rect x="0" y="0" width="0" height="0" stroke="none" fill="none" stroke-width="0"></rect>\n\n</g></marker><marker id="shape-library-markers-mim-covalent-bond-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="11" refY="6"><g id="g-src-shape-library-markers-mim-covalent-bond-svg-end-default" class="solid-stroke default-fill-color" transform="rotate(180, 6, 6)">\n\n	<!-- mim-covalent-bond markers: not much to see here! -->\n	<rect x="0" y="0" width="0" height="0" stroke="none" fill="none" stroke-width="0"></rect>\n\n</g></marker><marker id="shape-library-markers-mim-transcription-translation-svg-start-default" preserveAspectRatio="none" viewBox="0 0 20 24" markerWidth="20" markerHeight="24" markerUnits="strokeWidth" orient="auto" refX="0" refY="12"><g id="g-src-shape-library-markers-mim-transcription-translation-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-transcription-translation markers: two lines and an open trigular polygon, plus extended drawing-board rect -->\n\n	<rect stroke="none" x="0" y="11" width="12" height="2"></rect>\n	<line fill="none" stroke-width="1" x1="15" y1="12" x2="15" y2="5"></line>\n	<line fill="none" stroke-width="1" x1="15.5" y1="5" x2="8" y2="5"></line>\n	<polygon stroke-width="1" points="0,5 8,1 8,9"></polygon>\n\n</g></marker><marker id="shape-library-markers-mim-transcription-translation-svg-end-default" preserveAspectRatio="none" viewBox="0 0 20 24" markerWidth="20" markerHeight="24" markerUnits="strokeWidth" orient="auto" refX="20" refY="12"><g id="g-src-shape-library-markers-mim-transcription-translation-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 10, 12)">\n\n	<!-- mim-transcription-translation markers: two lines and an open trigular polygon, plus extended drawing-board rect -->\n\n	<rect stroke="none" x="0" y="11" width="12" height="2"></rect>\n	<line fill="none" stroke-width="1" x1="15" y1="12" x2="15" y2="5"></line>\n	<line fill="none" stroke-width="1" x1="15.5" y1="5" x2="8" y2="5"></line>\n	<polygon stroke-width="1" points="0,5 8,1 8,9"></polygon>\n\n</g></marker><marker id="shape-library-markers-mim-gap-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-mim-gap-svg-start-default" class="board-fill-color solid-stroke">\n\n	<!-- mim-gap markers: just an extended drawing-board rect -->\n	<!-- \n	TODO This could be refactored to make the shape match the viewbox.\n	It can overlap the side of the shape, blanking out a small part of it when the edge is at an angle.\n	-->\n\n	<rect stroke="none" x="0" y="5.3" width="8" height="1.4"></rect>\n\n</g></marker><marker id="shape-library-markers-mim-gap-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="12" refY="6"><g id="g-src-shape-library-markers-mim-gap-svg-end-default" class="board-fill-color solid-stroke" transform="rotate(180, 6, 6)">\n\n	<!-- mim-gap markers: just an extended drawing-board rect -->\n	<!-- \n	TODO This could be refactored to make the shape match the viewbox.\n	It can overlap the side of the shape, blanking out a small part of it when the edge is at an angle.\n	-->\n\n	<rect stroke="none" x="0" y="5.3" width="8" height="1.4"></rect>\n\n</g></marker><marker id="shape-library-markers-t-bar-svg-start-default" preserveAspectRatio="none" viewBox="0 0 10 20" markerWidth="10" markerHeight="20" markerUnits="strokeWidth" orient="auto" refX="0" refY="10"><g id="g-src-shape-library-markers-t-bar-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n        <!-- t-bar markers: vertical line; and extended drawing-board rect -->\n	\n	<rect stroke="none" x="0" y="9" width="8" height="2"></rect>\n	<line fill="none" stroke-width="1.8" x1="7" y1="0" x2="7" y2="20"></line>\n\n</g></marker><marker id="shape-library-markers-t-bar-svg-end-default" preserveAspectRatio="none" viewBox="0 0 10 20" markerWidth="10" markerHeight="20" markerUnits="strokeWidth" orient="auto" refX="10" refY="10"><g id="g-src-shape-library-markers-t-bar-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 5, 10)">\n\n        <!-- t-bar markers: vertical line; and extended drawing-board rect -->\n	\n	<rect stroke="none" x="0" y="9" width="8" height="2"></rect>\n	<line fill="none" stroke-width="1.8" x1="7" y1="0" x2="7" y2="20"></line>\n\n</g></marker><marker id="shape-library-markers-none-svg-start-default" preserveAspectRatio="none" viewBox="0 0 0 0" markerWidth="0" markerHeight="0" markerUnits="strokeWidth" orient="auto" refX="0" refY="6"><g id="g-src-shape-library-markers-none-svg-start-default" class="board-fill-color board-stroke-color node shape">\n\n	<rect x="0" y="0" width="0" height="0" stroke="none" fill="none" stroke-width="0"></rect>\n\n</g></marker><marker id="shape-library-markers-none-svg-end-default" preserveAspectRatio="none" viewBox="0 0 0 0" markerWidth="0" markerHeight="0" markerUnits="strokeWidth" orient="auto" refX="11" refY="6"><g id="g-src-shape-library-markers-none-svg-end-default" class="board-fill-color board-stroke-color node shape" transform="rotate(180, 0, 0)">\n\n	<rect x="0" y="0" width="0" height="0" stroke="none" fill="none" stroke-width="0"></rect>\n\n</g></marker><marker id="shape-library-markers-mim-branching-left-svg-start-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0.4" refY="6"><g id="g-src-shape-library-markers-mim-branching-left-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-branching-left markers: line and extended drawing-board rect -->\n\n	<rect stroke="none" x="0.4" y="5.3" width="3.1" height="1.4"></rect>\n	<line fill="none" stroke-width="1" x1="3.9" y1="6.2" x2="0.2" y2="0"></line>	\n\n</g></marker><marker id="shape-library-markers-mim-branching-left-svg-end-default" preserveAspectRatio="none" viewBox="0 0 12 12" markerWidth="12" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="11.6" refY="6"><g id="g-src-shape-library-markers-mim-branching-left-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 6, 6)">\n\n	<!-- mim-branching-left markers: line and extended drawing-board rect -->\n\n	<rect stroke="none" x="0.4" y="5.3" width="3.1" height="1.4"></rect>\n	<line fill="none" stroke-width="1" x1="3.9" y1="6.2" x2="0.2" y2="0"></line>	\n\n</g></marker><marker id="shape-library-markers-mim-branching-right-svg-start-default" preserveAspectRatio="none" viewBox="0 0 4 12" markerWidth="4" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="0.4" refY="6"><g id="g-src-shape-library-markers-mim-branching-right-svg-start-default" class="board-fill-color default-stroke-color solid-stroke">\n\n	<!-- mim-branching-right markers: line and extended drawing-board rect -->\n\n	<rect stroke="none" x="0.4" y="5.3" width="3.1" height="1.4"></rect>\n	<line fill="none" stroke-width="1" x1="0.2" y1="12" x2="3.9" y2="5.8"></line>	\n\n</g></marker><marker id="shape-library-markers-mim-branching-right-svg-end-default" preserveAspectRatio="none" viewBox="0 0 4 12" markerWidth="4" markerHeight="12" markerUnits="strokeWidth" orient="auto" refX="3.6" refY="6"><g id="g-src-shape-library-markers-mim-branching-right-svg-end-default" class="board-fill-color default-stroke-color solid-stroke" transform="rotate(180, 2, 6)">\n\n	<!-- mim-branching-right markers: line and extended drawing-board rect -->\n\n	<rect stroke="none" x="0.4" y="5.3" width="3.1" height="1.4"></rect>\n	<line fill="none" stroke-width="1" x1="0.2" y1="12" x2="3.9" y2="5.8"></line>	\n\n</g>\n</marker>\n<style type="text/css">	\n	/* default color for pathway elements */\n	.default-fill-color {\n		fill: black; \n	}\n	.default-stroke-color {\n		stroke: black;\n	}\n	\n	/* default color of the background drawing board */ 	\n	.board-fill-color {\n		fill: white;\n	}\n	.board-stroke-color {\n		stroke: white;\n	}\n\n	marker {\n		/* this is what should work per the spec\n		   stroke-dasharray: none; */\n		/* but I need to add this to make it work in Safari */\n		stroke-dasharray: 9999999999999999999999999;\n	}\n</style>\n</defs>\n</svg>\n';


var crossPlatformShapes = {
  init: function(args, callback){
    var customShapes = args.customShapes;
    var crossPlatformShapesInstance = this;
    this.svg.crossPlatformShapesInstance = this.svg.path.crossPlatformShapesInstance = crossPlatformShapesInstance;

    var targetSelector = args.targetSelector;
    var target = document.querySelector(targetSelector);
    var targetTagName = target.tagName.toLowerCase();
    var targetSelection = d3.select(target);
    var format, targetImageSelection;

    if (targetTagName === 'div') {
      format = args.format;
      this[format].targetSelection = targetSelection;
      this.setFormat(format, customShapes, targetTagName, targetSelection);
      crossPlatformShapesInstance[format].init(args, function(viewport) {
        if (!!callback) {
          callback(viewport);
        }
      });
    }
    else {
      format = targetTagName;
      this[format].targetImageSelection = targetSelection;
      this.setFormat(format, customShapes, targetTagName, targetSelection);
      this[format].init(args, function(viewport) {
        if (!!callback) {
          callback(viewport);
        }
      });
    }
  },
  setFormat: function(format, customShapes, targetTagName, targetSelection) {
    var crossPlatformShapesInstance = this;
    this[format].targetTagName = targetTagName;
    var presetShapesNames = [
      'arc',
      'arrow',
      'brace',
      'complex',
      'endoplasmicReticulum',
      'golgiApparatus',
      'hexagon',
      'lineCurved',
      'lineElbow',
      'lineSegmented',
      'lineStraight',
      'mimDegradation',
      'mitochondria',
      'ellipseDouble',
      'ellipse',
      'pentagon',
      'rectangle',
      'roundedRectangleDouble',
      'roundedRectangle',
      'sarcoplasmicReticulum',
      'triangle',
      'mimNecessaryStimulation',
      'mimBinding',
      'mimConversion',
      'mimStimulation',
      'mimModification',
      'mimCatalysis',
      'mimInhibition',
      'mimCleavage',
      'mimCovalentBond',
      'mimTranscriptionTranslation',
      'mimGap',
      'tBar',
      'mimBranchingLeft',
      'mimBranchingRight'
    ];
    presetShapesNames.forEach(function(presetShapeName) {
      crossPlatformShapesInstance[presetShapeName] = function(data, callback){
        return crossPlatformShapesInstance[format].path.render(presetShapeName, data, callback);
      };
    });

    if (!!customShapes) {
      crossPlatformShapesInstance.customShapes = customShapes;
      crossPlatformShapesInstance[format].image.customShapes = customShapes;
      d3.map(customShapes).keys().forEach(function(customShapeName) {
        crossPlatformShapesInstance[customShapeName] = function(data, callback){
          return crossPlatformShapesInstance[format].image.render(customShapeName, data, callback);
        };
      });
    }
  }
};

/*
arc
arrow
brace
complex
endoplasmic-reticulum
golgi-apparatus
hexagon
line-curved
line-elbow
line-segmented
line-straight
mim-degradation
mitochondria
ellipse-double
ellipse
pentagon
rectangle
rounded-rectangle-double
rounded-rectangle
sarcoplasmic-reticulum
triangle
mim-necessary-stimulation
mim-binding
mim-conversion
mim-stimulation
mim-modification
mim-catalysis
mim-inhibition
mim-cleavage
mim-covalent-bond
mim-transcription-translation
mim-gap
t-bar
mim-branching-left
mim-branching-right

arc
arrow
brace
complex
endoplasmicReticulum
golgiApparatus
hexagon
lineCurved
lineElbow
lineSegmented
lineStraight
mimDegradation
mitochondria
ellipseDouble
ellipse
pentagon
rectangle
roundedRectangleDouble
roundedRectangle
sarcoplasmicReticulum
triangle
mimNecessaryStimulation
mimBinding
mimConversion
mimStimulation
mimModification
mimCatalysis
mimInhibition
mimCleavage
mimCovalentBond
mimTranscriptionTranslation
mimGap
tBar
mimBranchingLeft
mimBranchingRight
//*/


crossPlatformShapes.pathCalculator = {};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arrow = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var pathData = [{ command: 'moveTo', points: [(x), y] },
    { command: 'lineTo', points: [x + width, (y + height/2)]},
    { command: 'lineTo', points: [(x), (y + height)] },
    { command: 'closePath', points: [] }];

  return pathData;
};


crossPlatformShapes.pathCalculator.brace = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;
  
  var pathData = [{command: 'moveTo', points: [x, (y + height)]},
    {command: 'bezierCurveTo', points: [(x), (y), (x + width/2), (y + height), (x + width/2), (y)]},
    {command: 'bezierCurveTo', points: [(x + width/2), (y + height), (x + width), (y), (x + width), (y + height)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.complex = function(data){
  'use strict';

    var x = data.x,
      y = data.y,
      width = data.width,
      height = data.height;

    var pathData = [{command: 'moveTo', points: [(x + 18), y]},
        {command: 'lineTo', points: [(x + width - 18), y] },
        {command: 'lineTo', points: [(x + width), (y + 18)] },
        {command: 'lineTo', points: [(x + width), (y + height - 18)] },
        {command: 'lineTo', points: [(x + width - 18), (y + height)] },
        {command: 'lineTo', points: [(x + 18), (y + height)] },
        {command: 'lineTo', points: [(x), (y + height - 18)] },
        {command: 'lineTo', points: [(x), (y + 18)] },
        {command: 'closePath', points: []}];
  return pathData;
};


crossPlatformShapes.pathCalculator.endoplasmicReticulum = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  // TODO: the commands below are just a copy of the commands for rectangle.
  // We need to convert the commented out pathData below to the HTML5 Canvas path command format.
  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'lineTo', points: [(x + width), y]},
    {command: 'lineTo', points: [(x + width), (y + height)]},
    {command: 'lineTo', points: [(x), (y + height)]},
    {command: 'closePath', points: []}];

    /*
  var pathData = 'm73.52756,56.60967c-5.62457,-18.60675 23.51463,-32.43358 23.40173,-45.06604c-0.34426,-4.86102 -10.48934,-8.89743 -18.28974,-5.33395c-17.04119,7.87556 -15.64949,29.30503 -21.20533,42.23387c-0.35661,3.60951 -7.36274,2.46926 -7.74964,-0.48694c-5.8512,-11.38871 17.13534,-24.48692 5.96075,-29.42586c-19.63467,-8.16979 -28.75184,21.15346 -22.0682,28.81784c7.4956,14.17602 -2.17949,24.40679 -6.74689,15.49637c-2.44209,-5.30613 6.06605,-11.08445 -0.80351,-16.17689c-4.31991,-2.79993 -11.75555,-0.64618 -16.15468,3.0943c-12.89117,10.73799 4.72957,40.98145 20.96467,36.14635c4.69833,-1.95989 -3.23603,-8.70151 3.90717,-9.59951c7.29767,-0.81255 5.17628,6.18889 7.68745,9.22691c2.3071,4.0509 4.83232,8.35538 10.7626,11.6237c4.78642,2.53724 15.29437,2.11225 16.77148,-1.95795c2.0318,-9.26291 -26.11129,-28.35848 -10.68903,-31.2815c18.55524,-2.71473 4.74866,23.84573 24.31006,29.69419c9.50188,2.02824 15.63902,-0.62194 14.81255,-4.03272c-2.74586,-11.26327 -25.13557,-22.6802 -24.96441,-33.14968';
  //*/

  return pathData;
};


crossPlatformShapes.pathCalculator.golgiApparatus = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  // TODO: the commands below are just a copy of the commands for rectangle.
  // We need to convert the commented out pathData below to the HTML5 Canvas path command format.
  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'lineTo', points: [(x + width), y]},
    {command: 'lineTo', points: [(x + width), (y + height)]},
    {command: 'lineTo', points: [(x), (y + height)]},
    {command: 'closePath', points: []}];

    /*
    var path1 = 'm58.4671,16.99297c-22.2053,-19.30712 37.3101,-19.538 25.5673,-3.1145c-8.8077,11.998 -17.0665,37.53828 -0.9417,64.06707c13.3147,17.47735 -41.7485,17.92546 -27.7555,-0.94919c11.3458,-18.99656 10.2868,-51.87342 3.1299,-60.00338l0,0z';

    var path2 = 'm31.2144,22.48219c-10.7917,-13.83614 29.8976,-12.81612 18.4075,0.4332c-4.067,4.79263 -5.7828,39.75796 1.1607,48.44653c8.5294,12.0082 -32.853,12.49764 -20.5002,-1.45349c6.9528,-11.2083 10.4738,-33.76451 0.932,-47.42624l0,0z';

    var path3 = 'm29.80396,32.77896c1.58418,7.4093 2.72346,10.80737 -1.48298,24.77019c-3.73195,8.38708 -3.6004,10.5513 -11.73233,12.53496c-6.6833,1.07092 -11.86483,-6.32111 -4.7933,-10.40477c4.85573,-3.63095 6.14109,-7.02681 6.65889,-14.82198c-0.23922,-6.14805 0.8145,-10.21755 -5.36692,-12.88742c-7.62432,-1.41744 -6.08804,-10.67651 4.82406,-8.95195c5.84935,0.66319 10.2824,5.52823 11.89258,9.76096z';


    var pathData = path1 + ' ' + path2 + ' ' + path3;
    //*/
  return pathData;
};


crossPlatformShapes.pathCalculator.hexagon = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;
    
  var pathData = [{command: 'moveTo', points: [(x + 0.25*width) , y]},
    {command: 'lineTo', points: [(x + 0.75*width), y]},
    {command: 'lineTo', points: [(x + width), (y+ 0.5*height)]},
    {command: 'lineTo', points: [(x + 0.75*width), (y + height)]},
    {command: 'lineTo', points: [(x + 0.25*width), (y + height)]},
    {command: 'lineTo', points: [x, (y+ 0.5*height)]},
    {command: 'closePath', points: []}];
    

  return pathData;
};


crossPlatformShapes.pathCalculator.lineCurved = function(data){
  'use strict';

  //for generating bezier curves through a path of points (pathpoints, not waypoints)
  var svgCurve = d3.svg.line()
  .x(function(d) {return d.x; })
  .y(function(d) {return d.y;})
  //.interpolate("cardinal");
  .interpolate("basis");

  var pathData = svgCurve(data.points);

  return pathData;
};


crossPlatformShapes.pathCalculator.lineElbow = function(data){
  'use strict';

  //for generating line segments through a path of points (pathpoints, not waypoints)
  var svgLine = d3.svg.line()
  .x(function(d) {return d.x;})
  .y(function(d) {return d.y;})
  .interpolate("linear");

  var pathData = svgLine(data.points);

  return pathData;
};



crossPlatformShapes.pathCalculator.lineSegmented = function(data){
  'use strict';

  //for generating line segments through a path of points (pathpoints, not waypoints)
  var svgLine = d3.svg.line()
  .x(function(d) {return d.x; })
  .y(function(d) {return d.y;})
  .interpolate("linear");

  var pathData = svgLine(data.points);

  return pathData;
};


crossPlatformShapes.pathCalculator.lineStraight = function(data){
  'use strict';

  var x0 = data.points[0].x,
    y0 = data.points[0].y,
    x1 = data.points[1].x,
    y1 = data.points[1].y;

  var pathData = [{command: 'moveTo', points: [x0, y0]},
    {command: 'lineTo', points: [x1, y1]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.mimDegradation = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var ellipse = crossPlatformShapes.pathCalculator.ellipse(data);
  var line = [{command: 'moveTo', points: [x, y]},
    {command: 'lineTo', points: [(x + width), (y + height)]}];
  var pathData = ellipse.concat(line);

  return pathData;
};


crossPlatformShapes.pathCalculator.mitochondria = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;
  var outerEllipse = crossPlatformShapes.pathCalculator.ellipse(data);
  /*
  // TODO: We need to convert the commented out pathData below to the HTML5 Canvas path command format
  // and concatenate it with the ellipse pathData.
  var innerShape = 'M' + (x + 14.894899) + ',' + (y + 26.347357) +
    'c4.363817,-0.741571 3.827518,17.036169 8.182638,16.183825' +
    'c8.27347,0.030762 2.982006,-28.148991 9.899754,-28.336687' +
    'c6.967995,-0.187704 2.246651,29.947527 9.204983,29.43981' +
    'c7.632813,-0.560024 0.507309,-32.935357 8.136253,-33.623082' +
    'c7.698521,-0.689259 2.919197,32.039941 10.628349,32.224557' +
    'c6.546684,0.160011 3.026451,-27.642808 9.56057,-26.921232' +
    'c7.192177,0.79388 0.664818,29.842905 7.781624,31.667604' +
    'c4.748405,1.215439 4.420822,-18.257757 9.204018,-17.440804' +
    'c11.128883,7.577278 8.628105,37.698658 -2.179977,44.645138' +
    'c-3.138542,0.698479 -3.965698,-10.502029 -7.112938,-9.905075' +
    'c-5.59005,1.058502 -3.982124,22.284088 -9.603096,21.799461' +
    'c-5.239281,-0.456947 -2.226364,-21.636383 -7.47047,-21.730232' +
    'c-6.961235,-0.116928 -3.357895,28.924408 -10.316231,28.495148' +
    'c-6.140846,-0.375397 -1.73064,-24.950363 -7.825104,-26.191963' +
    'c-5.681847,-1.156982 -5.378429,22.170242 -11.027426,20.680939' +
    'c-6.249069,-1.644684 -0.469624,-26.673519 -6.759275,-27.865887' +
    'c-3.728954,-0.706188 -2.647665,14.400654 -6.403677,14.545292' +
    'c-14.016198,-5.938736 -15.748776,-39.707981 -3.899994,-47.666811' +
    'z';
  var pathData = outerEllipse + ' ' + innerShape;
    //*/
  var pathData = outerEllipse;

  return pathData;
};


crossPlatformShapes.pathCalculator.ellipseDouble = function(data){
  'use strict';

  var outerEllipse = crossPlatformShapes.pathCalculator.ellipse(data);

  var innerEllipseData = data;
  var doubleLineGap = 2 * data.borderWidth || 6;
  innerEllipseData.x = data.x + doubleLineGap;
  innerEllipseData.y = data.y + doubleLineGap;
  innerEllipseData.width = data.width - 2*doubleLineGap;
  innerEllipseData.height = data.height - 2*doubleLineGap;
  var innerEllipse = crossPlatformShapes.pathCalculator.ellipse(innerEllipseData);

  var pathData = outerEllipse.concat(innerEllipse);
  return pathData;
};


crossPlatformShapes.pathCalculator.ellipse = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;
  var cx = x + width/2;
  var cy = y + height/2;
  var width_over_2 = width / 2,
    width_two_thirds = width * 2 / 3,
    height_over_2 = height / 2;

  var pathData = [{command: 'moveTo', points: [cx, (cy - height_over_2)]},
    {command: 'bezierCurveTo', points: [(cx + width_two_thirds), (cy - height_over_2), (cx + width_two_thirds), (cy + height_over_2), (cx), (cy + height_over_2)]},
    {command: 'bezierCurveTo', points: [(cx - width_two_thirds), (cy + height_over_2), (cx - width_two_thirds), (cy - height_over_2), (cx), (cy - height_over_2)]}];
  return pathData;
};


crossPlatformShapes.pathCalculator.pentagon = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;
   
  var pathData = [{command: 'moveTo', points: [x, (y + 0.81*height)]},
    {command: 'lineTo', points: [x, (y+ 0.19*height)]},
    {command: 'lineTo', points: [(x+ 0.62*width), y]},
    {command: 'lineTo', points: [(x+ width), (y+ 0.5*height)]},
    {command: 'lineTo', points: [(x+ 0.62*width), (y + height)]},
    {command: 'closePath', points: []}];

  return pathData;
};


crossPlatformShapes.pathCalculator.rectangle = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'lineTo', points: [(x + width), y]},
    {command: 'lineTo', points: [(x + width), (y + height)]},
    {command: 'lineTo', points: [(x), (y + height)]},
    {command: 'closePath', points: []}];

  return pathData;
};


crossPlatformShapes.pathCalculator.roundedRectangleDouble = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height,
    borderWidth = data.borderWidth;

  var outerRoundedRectangle = crossPlatformShapes.pathCalculator.roundedRectangle(data);

  var innerRoundedRectangleData = data;
  var doubleLineGap = 2 * borderWidth || 6;
  innerRoundedRectangleData.x = x + doubleLineGap;
  innerRoundedRectangleData.y = y + doubleLineGap;
  innerRoundedRectangleData.width = width - 2*doubleLineGap;
  innerRoundedRectangleData.height = height - 2*doubleLineGap;
  var innerRoundedRectangle = crossPlatformShapes.pathCalculator.roundedRectangle(innerRoundedRectangleData);
  var pathData = outerRoundedRectangle.concat(innerRoundedRectangle);

  return pathData;
};


crossPlatformShapes.pathCalculator.roundedRectangle = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var pathData = [{command: 'moveTo', points: [x, (y + 10)]}, // start at upper left corner, just before curve
        {command: 'bezierCurveTo', points: [x, (y + 10 - 5.43379), (x + 4.56621), (y), (x + 10), (y)]},
        {command: 'lineTo', points: [(x + width - 10), (y)]}, // move to the upper right corner, just before curve
        {command: 'bezierCurveTo', points: [(x + width - 10 + 5.43379), (y), (x + width), (y + 4.56621), (x + width), (y + 10)]},
        {command: 'lineTo', points: [(x + width), (y + height - 10)]}, // move to the lower right corner, just before curve
        {command: 'bezierCurveTo', points: [(x + width), (y + height - 10 + 5.43379), (x + width - 4.56621), (y + height), (x + width - 10), (y + height)]},
        {command: 'lineTo', points: [(x + 10), (y + height)]}, // move to the lower left corner, just before curve
        {command: 'bezierCurveTo', points: [(x + 10 - 5.43379), (y + height), (x), (y + height - 4.56621), (x), (y + height - 10)]},
        {command: 'closePath', points: []}];
  return pathData;
};


crossPlatformShapes.pathCalculator.sarcoplasmicReticulum = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  // TODO: the commands below are just a copy of the commands for rectangle.
  // We need to convert the commented out pathData below to the HTML5 Canvas path command format.
  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'lineTo', points: [(x + width), y]},
    {command: 'lineTo', points: [(x + width), (y + height)]},
    {command: 'lineTo', points: [(x), (y + height)]},
    {command: 'closePath', points: []}];

    /*
  var pathData = 'm46.60182,1.40724c-32.37224,1.34138 -36.32004,22.77011 -26.50318,38.12777c9.31826,18.3425 -18.7656,30.15016 2.56955,49.37807c16.82126,13.11594 46.33175,6.10508 52.12638,-8.56826c5.89916,-15.24847 -10.95099,-26.0272 -3.29316,-40.96135c10.85342,-19.88432 -0.77615,-38.13043 -24.89959,-37.97624z';
  //*/

  return pathData;
};


crossPlatformShapes.pathCalculator.triangle = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var pathData = [{command: 'moveTo', points: [x, y]},
        {command: 'lineTo', points: [(x + width), (y + height/2)]},
        {command: 'lineTo', points: [x, (y + height)]},
        {command: 'closePath', points: []}];
  
  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.tBar = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'lineTo', points: [(x), (y + height)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.pathCalculator.arc = function(data){
  'use strict';

  var x = data.x,
    y = data.y,
    width = data.width,
    height = data.height;

  var yControlPoint = height * (2/3);

  var pathData = [{command: 'moveTo', points: [x, y]},
    {command: 'bezierCurveTo', points: [(x), (y + yControlPoint), (x + width), (y + yControlPoint), (x + width), (y)]}];

  return pathData;
};


crossPlatformShapes.customShapes = {
  arc: {
    href: 'http://www.example.org/arc.png'
  },
  brace:{
    href: 'http://www.example.org/brace.png'
  },
  rectangle:{
    href: 'http://www.example.org/rectangle.png'
  }
};


crossPlatformShapes.svg = {
  init: function(args, callback){
    var width = args.width || '100%',
      height = args.height || '100%',
      backgroundColor = args.backgroundColor || '#ffffff';

    var crossPlatformShapesInstance = this.crossPlatformShapesInstance;
    var viewport, defs;
    if (this.targetTagName !== 'svg') {
      var id = args.id || 'cross-platform-shape-svg';
      targetImageSelection = this.targetSelection.append('svg')
      .attr('id', id)
      .attr('version', '1.1')
      .attr('baseProfile', 'full')
      .attr('xmlns', 'http://www.w3.org/1999/xlink')
      .attr('xmlns:xmlns:xlink', 'http://www.w3.org/1999/xlink')
      .attr('xmlns:xmlns:ev', 'http://www.w3.org/2001/xml-events')
      .attr('preserveAspectRatio', 'xMidYMid')
      .attr('width', width)
      .attr('height', height)
      .attr('style', 'background-color:' + backgroundColor + '; ');

      this.path.targetImageSelection = this.image.targetImageSelection = targetImageSelection;

      defs = targetImageSelection.append('defs')
      .attr('id', 'defs');

      this.marker.targetImageSelectionDefs = defs;

      viewport = targetImageSelection.append('g')
      .attr('id', 'viewport');
    }
    else {
      targetImageSelection = this.targetImageSelection;
      this.path.targetImageSelection = this.image.targetImageSelection = targetImageSelection;
      this.marker.targetImageSelectionDefs = this.targetImageSelection.select('defs');
      viewport = targetImageSelection.select('#viewport');
      if (!viewport[0][0]) {
        viewport = targetImageSelection.select('g');
      }
    }

    //this.path.targetImage = targetImage;
    this.path.availableMarkers = this.marker.availableMarkers = {};
    this.path.backgroundColor = this.marker.backgroundColor = backgroundColor;
    targetImageSelection.attr('style', 'background-color:' + backgroundColor + '; ');

    if (!!callback) {
      callback(viewport);
    }
  }
};


crossPlatformShapes.svg.image = {
  render: function(shapeName, data, callback){
    var customShapes = this.customShapes;
    var shapeSelection = targetImageSelection.select(data.containerSelector).append('image')
    .attr('xlink:xlink:href', customShapes[shapeName].href)
    .attr('x', data.x || 0)
    .attr('y', data.y || 0)
    .attr('width', data.width || 0)
    .attr('height', data.height || 0);

    var rotation = data.rotation;
    if (!!rotation) {
      shapeSelection.attr('transform', 'rotate(' + rotation + ',' + (data.x + data.width/2) + ',' + (data.y + data.height/2) + ')');
    }
    if (!!callback) {
      callback(shapeSelection[0][0]);
    }
  }
};


crossPlatformShapes.svg.marker = {
  generateId: function(name, position, color){
    // only keep the alphanumeric characters and dashes. convert to lower case. start with 'id-' just to ensure the first character is a letter.
    var id = ('id-' + name + '-' + position + '-' + color).replace(/[^A-Za-z0-9-]/g, '').toLowerCase();

    return id;
  },
  append: function(name, position, color, callback) {
    var availableMarkers = this.availableMarkers;
    var targetImageSelectionDefs = this.targetImageSelectionDefs;
    var backgroundColor = this.backgroundColor;

    // TODO move at least some of this code into pathCalculator
    var markerData = {
      arrow: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:5.4,
            width:2,
            height:1.2,
            stroke:backgroundColor,
            fill:backgroundColor
          },
          {
            elementTag: 'polygon',
            points:'12,11 0,6 12,1',
            'stroke-width':0,
            fill:color
          }
        ]
      },
      mimBinding: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:5.4,
            width:2,
            height:1.2,
            stroke:backgroundColor,
            fill:backgroundColor
          },
          {
            elementTag: 'polygon',
            points:'12,12 0,6 12,0 5,6',
            'stroke-width':0,
            fill:color
          }
        ]
      },
      mimNecessaryStimulation: {
        markerElement: {
          markerWidth:16,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:5.4,
            width:2,
            height:1.2,
            stroke:'none',
            fill:backgroundColor
          },
          {
            elementTag: 'line',
            x1:14,
            y1:0,
            x2:14,
            y2:12,
            stroke:color,
            'stroke-width':1,
            fill:'none'
          },
          {
            elementTag: 'line',
            x1:16,
            y1:6,
            x2:16,
            y2:6,
            stroke:'none',
            fill:'none'
          },
          {
            elementTag: 'polygon',
            points:'0,6 9,11 9,1',
            'stroke-width':1,
            stroke:color,
            fill:backgroundColor
          }
        ]
      },
      mimStimulation: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:5.4,
            width:2,
            height:1.2,
            stroke:'none',
            fill:backgroundColor
          },
          {
            elementTag: 'line',
            x1:12,
            y1:6,
            x2:12,
            y2:6,
            stroke:'none',
            fill:'none'
          },
          {
            elementTag: 'polygon',
            points:'0,6 11,11 11,1',
            'stroke-width':1,
            stroke:color,
            fill:backgroundColor
          }
        ]
      },
      mimModification: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:5.4,
            width:2,
            height:1.2,
            stroke:backgroundColor,
            fill:backgroundColor
          },
          {
            elementTag: 'polygon',
            points:'12,12 0,6 12,0 5,6',
            'stroke-width':0,
            fill:color
          }
        ]
      },
      mimCatalysis: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'circle',
            cx:6,
            cy:6,
            r:'5.3px',
            stroke:color,
            'stroke-width':1,
            fill:backgroundColor
          }
        ]
      },
      mimCleavage: {
        markerElement: {
          markerWidth:20,
          markerHeight:30
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:14.3,
            width:18.4,
            height:1.4,
            stroke:backgroundColor,
            fill:backgroundColor
          },
          {
            elementTag: 'line',
            stroke:color,
            'stroke-width':1,
            x1:18,
            y1:14.5,
            x2:18,
            y2:30
          },
          {
            elementTag: 'line',
            stroke:color,
            'stroke-width':1,
            x1:18,
            y1:30,
            x2:0,
            y2:0
          }

        ]
      },
      mimCovalentBond: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:0,
            width:0,
            height:0,
            stroke:backgroundColor,
            'stroke-width':0,
            fill:backgroundColor
          }
        ]
      },
      mimTranscriptionTranslation: {
        markerElement: {
          markerWidth:20,
          markerHeight:24
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:11,
            width:12,
            height:2,
            stroke:backgroundColor,
            fill:backgroundColor
          },
          {
            elementTag: 'line',
            stroke:color,
            fill:'none',
            'stroke-width':1,
            x1:15,
            y1:12,
            x2:15,
            y2:5
          },
          {
            elementTag: 'line',
            stroke:color,
            fill:'none',
            'stroke-width':1,
            x1:15.5,
            y1:5,
            x2:8,
            y2:5
          },
          {
            elementTag: 'polygon',
            points:'0,5 8,1 8,9',
            'stroke-width':1,
            stroke:color,
            fill:backgroundColor
          }
        ]
      },
      mimGap: {
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:5.3,
            width:8,
            height:1.4,
            stroke:'none',
            fill:backgroundColor
          }
        ]
      },
      mimBranchingLeft: { // TODO: this is just a copy of arrow. it needs to be updated.
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0.4,
            y:5.3,
            width:3.1,
            height:1.4,
            fill:backgroundColor,
            stroke:'none'
          },
          {
            elementTag: 'line',
            fill:'none',
            stroke:color,
            'stroke-width':1,
            x1:3.9,
            y1:6.2,
            x2:0.2,
            y2:0
          }
        ]
      },
      mimBranchingRight: { // TODO: this is just a copy of arrow. it needs to be updated.
        markerElement: {
          markerWidth:12,
          markerHeight:12
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0.4,
            y:5.3,
            width:3.1,
            height:1.4,
            fill:backgroundColor,
            stroke:'none'
          },
          {
            elementTag: 'line',
            fill:'none',
            stroke:color,
            'stroke-width':1,
            x1:0.2,
            y1:12,
            x2:3.9,
            y2:5.8
          }
        ]
      },
      tBar: {
        markerElement: {
          markerWidth:10,
          markerHeight:20
        },
        shapes: [
          {
            elementTag: 'rect',
            x:0,
            y:9,
            width:8,
            height:2,
            fill:backgroundColor
          },
          {
            elementTag: 'line',
            x:0,
            y:0,
            width:12,
            height:12,
            stroke:color,
            'stroke-width':1.8,
            x1:7,
            y1:0,
            x2:7,
            y2:20
          }
        ]
      }
    };

    markerData.mimInhibition = markerData.tBar;
    markerData.mimConversion = markerData.arrow;

    if (!!markerData[name]) {
      var markerId = this.generateId(name, position, color);
      var markerAttributeValue = 'url(#' + markerId + ')';
      if (availableMarkers[markerId]) {
        callback(markerAttributeValue);
      }
      else {
        var marker = targetImageSelectionDefs.append('marker')
        .attr('id', markerId)
        .attr('orient', 'auto')
        .attr('markerUnits', 'strokeWidth')
        .attr('preserveAspectRatio', 'none')
        .attr('refY', markerData[name].markerElement.markerHeight/2)
        .attr('viewBox', '0 0 ' + markerData[name].markerElement.markerWidth + ' ' + markerData[name].markerElement.markerHeight);

        d3.map(markerData[name].markerElement).entries().forEach(function(attribute) {
          marker.attr(attribute.key, attribute.value);
        });
        if (position === 'end') {
          marker.attr('refX', markerData[name].markerElement.markerWidth);
        }
        else {
          marker.attr('refX', 0);
        }

        var markerContainer = marker.append('g')
        .attr('id', 'g-' + markerId);

        if (position === 'end') {
          markerContainer.attr('transform', 'rotate(180, ' + markerData[name].markerElement.markerWidth/2 + ', ' + markerData[name].markerElement.markerHeight/2 + ')');
        }

        markerData[name].shapes.forEach(function(shape) {
          var shapeSelection = markerContainer.append(shape.elementTag);
          d3.map(shape).entries().forEach(function(attribute) {
            if (attribute.key !== 'elementTag') {
              shapeSelection.attr(attribute.key, attribute.value);
            }
          });
        });
        availableMarkers[markerId] = true;
        callback(markerAttributeValue);
      }
    }
    else {
      console.warn('Marker (arrowhead) named "' + name + '" is not available.');
      callback('none');
    }
  }
};


crossPlatformShapes.svg.path = {
  generateMarkerId: function(name, position, color){
    // only keep the alphanumeric characters and dashes. convert to lower case. start with 'id-' just to ensure the first character is a letter.
    var id = ('id-' + name + '-' + position + '-' + color).replace(/[^A-Za-z0-9-]/g, '').toLowerCase();

    return id;
  },
  render: function(shapeName, data, callback) {
    var svgPathGenerator = this;
    var targetImageSelection = this.targetImageSelection;
    var availableMarkers = this.availableMarkers;
    var crossPlatformShapesInstance = this.crossPlatformShapesInstance;
    var attributeDependencyOrder = [
      'color',
      'markerStart',
      'markerEnd'
    ];
    var canvasPathCommandToSvgPathCommandMappings = {
      moveTo: 'M',
      lineTo: 'L',
      closePath: 'Z',
      bezierCurveTo: 'C',
      quadraticCurveTo: 'Q'
    };

    var shapeSelection = targetImageSelection.select(data.containerSelector).append('path');

    // TODO rewrite the path calculation code to not use the d3 path generators
    var shapesUsingD3PathGenerators = [
      'lineCurved',
      'lineElbow',
      'lineSegmented'
    ];
    var d = '';
    if (shapesUsingD3PathGenerators.indexOf(shapeName) === -1) {
      var pathSegments = crossPlatformShapes.pathCalculator[shapeName](data);
      // the path segments are defined using the Canvas path command terms. The path commands used are only those
      // that are common to both Canvas and SVG
      pathSegments.forEach(function(pathSegment) {
        d += canvasPathCommandToSvgPathCommandMappings[pathSegment.command];
        d += pathSegment.points.join(',');
      });
    }
    else {
      d = crossPlatformShapes.pathCalculator[ shapeName ](data);
    }
    shapeSelection.attr('d', d);


    var backgroundColor = data.backgroundColor || 'transparent';
    shapeSelection.attr('fill', backgroundColor);

    var color;

    var svgPathAttributeGenerator = {
      id: function(idValue){
        shapeSelection.attr('id', idValue);
      },
      strokeDasharray: function(strokeDasharrayValue){
        shapeSelection.attr('stroke-dasharray', strokeDasharrayValue);
      },
      fillOpacity: function(fillOpacityValue){
        shapeSelection.attr('fill-opacity', fillOpacityValue);
      },
      color: function(colorValue){
        color = colorValue;
        shapeSelection.attr('stroke', colorValue);
      },
      markerStart: function(markerStartValue) {
        crossPlatformShapesInstance.svg.marker.append(markerStartValue, 'start', color, function(markerAttributeValue) {
          shapeSelection.attr('marker-start', markerAttributeValue);
        });
      },
      markerEnd: function(markerEndValue) {
        crossPlatformShapesInstance.svg.marker.append(markerEndValue, 'end', color, function(markerAttributeValue) {
          shapeSelection.attr('marker-end', markerAttributeValue);
        });
      },
      rotation: function(rotationValue) {
        var transform = 'rotate(' + rotationValue + ',' + (data.x + data.width/2) + ',' + (data.y + data.height/2) + ')';
        shapeSelection.attr('transform', transform);
      },
      borderWidth: function(borderWidthValue) {
        shapeSelection.attr('stroke-width', borderWidthValue);
      }
    };

    // These are generic attributes that can apply to any pathShape.
    var attributeListItemName, attributeListItemValue;
    var attributeList = d3.map(data).entries().sort(function(a, b) {
      return attributeDependencyOrder.indexOf(a.key) - attributeDependencyOrder.indexOf(b.key);
    });
    attributeList.forEach(function(attributeListItem){
      attributeListItemName = attributeListItem.key;
      attributeListItemValue = attributeListItem.value;
      if (svgPathAttributeGenerator.hasOwnProperty(attributeListItemName)) {
        svgPathAttributeGenerator[attributeListItemName](attributeListItemValue);
      }
    });

    if (!!callback) {
      callback(shapeSelection[0][0]);
    }
  }
};


crossPlatformShapes.canvas = {};
